# نقاط الضعف والتحسينات — عجلة الولاء

مراجعة سريعة لاستكمال المشروع: نقاط الضعف الحالية واقتراحات التحسين.

---

## 1. الأمان

| النقطة | الوضع الحالي | التحسين المقترح |
|--------|---------------|------------------|
| **قواعد Firestore** | `canWrite()` = `isAuthenticated() \|\| true` → الكتابة مفتوحة لأي عميل. | إزالة `\|\| true` وربط الكتابة بـ Firebase Auth (مثلاً بعد تسجيل دخول الأدمن عبر Auth). أو على الأقل توثيق أن الإنتاج الحالي «مفتوح كتابة» للمشاريع المحدودة فقط. |
| **جلسة الأدمن** | محمية بـ `sessionStorage` + TTL 24 ساعة. أي جهاز يعرف الكود يمكنه الدخول. | اختياري: ربط الجلسة بـ Firebase Auth أو بـ IP/جهاز إذا أردت تقييد الدخول. |
| **Cloud Function `getFirestoreUsage`** | أي عميل يملك إعدادات المشروع يستطيع استدعاءها (يعرض أرقام قراءة/كتابة فقط). | اختياري: التحقق من أن الطالب مسجّل كأدمن (مثلاً عبر Custom Claim أو كود مؤقت يُمرَّر بعد التحقق من الأدمن). |
| **كود الأدمن في البيئة** | `VITE_ADMIN_CODE` ظاهر في حزمة الويب عند التحقق المحلي. | عند استخدام Firebase: الاعتماد على Cloud Function فقط (لا تحقق محلي) حتى لا يُعرَض الكود في الـ bundle. |

---

## 2. الاختبارات

| النقطة | الوضع الحالي | التحسين المقترح |
|--------|---------------|------------------|
| **تغطية الوحدة** | اختبارات لـ `lookup`, `adminAuth`, `codeUtils`, `spinEligibility`, `excelParser.merge`, `firestoreLoyaltyService`, `CheckPhoneStep`. | إضافة اختبارات لـ: `Wheel` (اختيار الجائزة، التوقيت)، `PhoneStep`، `guestExport`، `wheelSpunStorage`، ووحدات الدمج/التحقق في `excelParser`. |
| **E2E** | يوجد `guest-lookup` و `admin-login`. اختبار الأدمن قد يفشل إذا كان السيرفر يعيد استخدام dev مع Firebase وكود مختلف. | توحيد بيئة E2E (مثلاً إيقاف Firebase للاختبار أو ضبط كود ثابت في السيرفر). إضافة E2E لمسار الضيف الكامل: استعلام → عجلة → جائزة → واتساب. |
| **اختبار التكامل** | لا يوجد اختبار يربط واجهة + تخزين + Firestore (إن وُجد). | سيناريو واحد على الأقل: حفظ إعدادات من الأدمن ثم قراءتها في صفحة الضيف (مع mock لـ Firestore إن لزم). |

---

## 3. تجربة المستخدم والمرونة

| النقطة | الوضع الحالي | التحسين المقترح |
|--------|---------------|------------------|
| **حجم ملفات الرفع** | لا حد صريح لحجم ملف الإكسل في الواجهة. | حد أقصى (مثلاً 5–10 MB) مع رسالة واضحة عند تجاوزه. |
| **التحقق من المدخلات** | الجوال: 9 أرقام كحد أدنى. الاسم والهوية: trim فقط. | حدود معقولة لطول الاسم (مثلاً 2–100 حرف) والهوية؛ رسالة خطأ واضحة عند تجاوزها. |
| **وضع Offline** | التطبيق يعتمد على التخزين المحلي و Firestore. عند انقطاع النت قد تفشل عمليات دون رسالة موحّدة. | رسالة عامة «تحقق من الاتصال» عند فشل الشبكة في المسارات الحرجة؛ أو وضع offline بسيط (قراءة من الكاش فقط) مع إشعار. |
| **PWA / Service Worker** | يوجد `sw.js` مع كاش. إصدار الكاش `CACHE_NAME` يُحدَّث يدوياً. | ربط تحديث `CACHE_NAME` بالإصدار (مثلاً من `package.json` أو من build) حتى لا يبقى المستخدم على نسخة قديمة بعد النشر. |

---

## 4. الأداء والصيانة

| النقطة | الوضع الحالي | التحسين المقترح |
|--------|---------------|------------------|
| **تحميل الصفحة** | العجلة والخطوط والأصوات تُحمّل مع الصفحة. | تأخير تحميل الأصوات حتى أول تفاعل؛ التأكد من `font-display: swap` (موجود في الخطوط). |
| **حجم الحزم** | فصل Firebase و XLSX في chunks. | مراجعة استخدام XLSX: إن كان فقط في الأدمن، تأكيد lazy load لصفحة الأدمن حتى لا يحمّل الضيف هذه المكتبة. |
| **تعقيد AdminPage** | ملف واحد كبير (لوحة التحكم + إعدادات + رفع + سجل). | تقسيم إلى مكوّنات فرعية أو tabs (مثلاً: إحصائيات، رفع ملفات، إعدادات، سجل) لتحسين القراءة وإعادة الاستخدام. |

---

## 5. التوثيق والعمليات

| النقطة | الوضع الحالي | التحسين المقترح |
|--------|---------------|------------------|
| **إعداد الإنتاج** | توثيق في الملفات و `docs/`. | ملف واحد `docs/DEPLOYMENT.md`: متطلبات البيئة، ضبط Firebase (Rules، Functions، env)، تحديث `CACHE_NAME`، واختبار ما بعد النشر. |
| **قائمة التحقق قبل النشر** | مذكورة جزئياً في الرولز. | قائمة قصيرة: بناء + اختبارات + قواعد Firestore + كود الأدمن على السيرفر + اختبار دخول أدمن ومسار ضيف. |
| **إصدار التطبيق** | معروض في لوحة الأدمن. | التأكد من أن الإصدار يظهر أيضاً في بيئة الإنتاج (مثلاً من متغير بناء أو من وسم النشر). |

---

## أولويات تنفيذ مقترحة

1. **أمان (إنتاج):** مراجعة `firestore.rules` — إما تفعيل `isAuthenticated()` للكتابة أو توثيق قرار «كتابة مفتوحة» والمخاطر.
2. **تجربة المستخدم:** حد حجم ملف الرفع + تحقق من طول الاسم/الهوية + رسائل خطأ واضحة عند فشل الشبكة.
3. **اختبارات:** E2E لمسار الضيف الكامل (استعلام → عجلة → جائزة) وربط بيئة الأدمن E2E بكود ثابت أو بدون Firebase.
4. **صيانة:** تقسيم `AdminPage` وتحديث `CACHE_NAME` تلقائياً مع الإصدار.

بعد تنفيذ (1) و (2) و (3) يصبح المشروع جاهزاً للإنتاج المحدود مع توثيق واضح لما تم وما المتبقي (مثل تفعيل Auth كامل لاحقاً).

---

## ما تم تنفيذه (خطة الاستكمال)

- **توثيق قواعد Firestore:** إضافة تعليق في أعلى `firestore.rules` يوضح أن الكتابة حالياً مفتوحة للإنتاج المحدود وكيفية تفعيل الحماية.
- **حد حجم ملف الرفع:** حد أقصى 10 MB في `AdminPage` مع رسالة خطأ واضحة عند التجاوز.
- **التحقق من طول الاسم والهوية:** ثوابت في `src/constants/validation.ts` وتطبيقها في `CheckPhoneStep` و `PhoneStep` (الاسم 2–100 حرف، الهوية 2–20 حرفاً).
- **رسائل فشل الشبكة:** مراجعة مسارات الضيف — الاعتماد على الرسالة الموحّدة «تعذّر الإجراء. تحقق من الاتصال وحاول مرة أخرى.» في الـ catch.
- **E2E:** استقرار بيئة الأدمن (`reuseExistingServer: false` وضبط الكود وFirebase في الـ config)، وإضافة `e2e/guest-full-flow.spec.ts` لمسار الضيف (استعلام، ظهور العجلة أو التسجيل، وعند توفر ضيف مسجّل: تدوير العجلة وظهور شاشة الجائزة).
- **ربط CACHE_NAME بالإصدار:** سكربت `scripts/inject-sw-version.cjs` يُشغّل قبل `vite build` لتحديث `CACHE_NAME` في `public/sw.js` من إصدار `package.json`.
- **توثيق النشر:** إنشاء `docs/DEPLOYMENT.md` (متطلبات البيئة، ضبط Firebase، قائمة التحقق قبل النشر).
- **قائمة التحقق:** إضافتها إلى `README.md` وإلى `DEPLOYMENT.md`.

## ما تبقى (للمرحلة لاحقة)

- تفعيل Firebase Authentication وربط كتابة Firestore بـ `isAuthenticated()` فقط.
- حماية Cloud Function `getFirestoreUsage` بتحقق أدمن.
- تقسيم `AdminPage` إلى مكوّنات فرعية أو tabs.
- اختبارات وحدة إضافية لـ Wheel، PhoneStep، guestExport، wheelSpunStorage.
