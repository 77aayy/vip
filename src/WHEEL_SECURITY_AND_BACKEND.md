# العجلة: نتيجة من الخادم وأمان الكود (للمرحلة القادمة)

هذا الملف يوضح **المقترحات الأمنية وتجربة العجلة** عند الانتقال إلى Backend (مثلاً Google Apps Script أو سيرفر خاص).

---

## ١. نتيجة العجلة من الخادم (Server-Side Result)

### الوضع الحالي (Client-Side)
- النتيجة تُحسب في المتصفح عند انتهاء دوران العجلة (`onSpinEnd`).
- العجلة تدور ثم الكود يحدد الجائزة بناءً على الزاوية النهائية.
- **المشكلة:** لو النتيجة تُحدد بعد ما العجلة وقفت، أو من سيرفر بطيء، الضيف قد يشك أن الجائزة "متفبركة" أو فيها Lag.

### المقترح عند وجود Backend
1. **تحديد الجائزة قبل الدوران:**
   - عند ضغط "دور العجلة" (أو عند التحقق من الرقم)، الطلب يروح للـ Backend.
   - الـ Backend يحدد الجائزة (حسب الاحتمالات والـ quota) ويرجع: `{ prizeId, voucherCode }`.
   - التطبيق يحفظ النتيجة ثم يلف العجلة **ليوقف على الشريحة المحددة** (الزاوية تُحسب من `prizeId`).
2. **النتيجة لا تتغير بعد الإرسال:**
   - الكود والجائزة مُسجَّلين في الشيت (أو DB) قبل ما العجلة تخلص دوران.
   - مفيش "تعديل" من الفرونت بعد كده — فقط عرض النتيجة المُرسلة من الخادم.

### خلاصة
- **الآن:** النتيجة تُحسب في الفرونت بعد الدوران (منطقياً صحيح لكن يفضل نقلها للسيرفر لاحقاً).
- **لاحقاً:** النتيجة + الكود يُحددون في الـ Backend أولاً، ثم العجلة تلف وتوقف على نفس النتيجة → تجربة أوضح وأكثر مصداقية.

---

## ٢. أمان كود التحقق (الواتساب)

### الهدف
منع أي حد يبعث رسالة واتساب يدوية بكود من دماغه ويقول "دي جائزتي".

### المقترح عند وجود Backend (مثلاً Google Sheets + Apps Script)
1. **الكود يُولَّد في الخادم فقط:**
   - عند تسجيل محاولة (رقم + اختيار العجلة أو التسجيل المجاني)، الـ Script يولد كود فريد (مثلاً 8 حروف/أرقام) ويحفظه في الصف في الشيت.
   - نفس الكود يُرجَع للفرونت لعرضه للضيف وإرساله للواتساب.
2. **ربط الكود بالرقم والسجل:**
   - في الشيت: عمود للكود، عمود للرقم، عمود للجائزة، عمود للوقت.
   - الاستقبال عند التحقق: يبحث عن الصف اللي فيه نفس الكود والرقم؛ لو ملقاش أو الكود منتهي الصلاحية → ميقبلش.
3. **عدم الاعتماد على كود مولَّد من الفرونت فقط:**
   - حالياً الكود يُولَّد في المتصفح (`generateCode()` في `GuestPage.tsx`). لو في مرحلة لاحقة الـ Webhook يكتب في الشيت، يفضل أن **الشيت أو الـ Script** يولد الكود ويرجعه في الـ Response (أو يخزنه ويقبل الطلبات فقط بالـ Request من الفرونت بدون كود جاهز من الفرونت).

### خلاصة
- **الآن:** الكود يُولَّد في الفرونت ويُرسل للاستقبال؛ الشيت يستقبل بيانات العضو (رقم، اسم، مصدر) بدون كود تحقق من سيرفر.
- **لاحقاً:** الكود يُولَّد في الـ Backend ويرتبط برقم + صف في الشيت؛ التحقق يتم بمطابقة الكود + الرقم في الشيت.

---

## ٣. ملخص التطبيق الحالي

| البند              | الحالة الحالية |
|-------------------|----------------|
| توحيد المسار (DRY) | ✅ الزرين → نفس خطوة "ادخل رقمك" ثم موجود → عجلة، غير موجود → فورم |
| منع الإرسال المزدوج | ✅ Ref في الخطوات + قفل 6 ثوان في `exportNewGuest` |
| نتيجة من الخادم   | ⏳ يحتاج Backend يحدد الجائزة والكود قبل دوران العجلة |
| أمان الكود        | ⏳ يحتاج توليد الكود وربطه بالرقم في الشيت/سكربت |
| Offline Persistence | ✅ LocalStorage للتصدير الفاشل + flush عند التحميل وعند online و visibilitychange |
| تباطؤ العجلة      | ✅ Cubic-Bezier(0.1, 0, 0, 1) في RAF — حركة فخمة (احتكاك) |
| التحقق قبل الدوران | ✅ checkEligibilityUrl — العجلة لا تبدأ إلا بعد تأكيد السيرفر |
| Token Validation  | ✅ UUID في الجلسة يُرسل مع كل تصدير؛ السيرفر يتحقق ولم يُستخدم |
| تقنيع البيانات    | ✅ اسم مقنّع (أ****) + "هل رقم هويتك المنتهي بـ ***45؟" للعائدين |

---

## ٣.١. Logic Block: تأكيد السيرفر قبل الدوران

عند الانتقال من localStorage إلى Firebase أو Google Sheets:

- **لا تبدأ العجلة إلا بعد تأكيد السيرفر** أن هذا الرقم "لم يسبق له اللعب اليوم" (أو حسب قواعدك).
- في المشروع: إعداد **checkEligibilityUrl** (اختياري). عند الضغط على "دور العجلة" يُستدعى هذا الرابط بـ `{ phone, sessionToken }`؛ إذا الرد `allowed: false` لا ننتقل لشاشة العجلة ونعرض رسالة للمستخدم.
- **فترة 15 يوم (Cooldown):** الفرونت يحسبها من جهاز النزيل (localStorage + Date.now()) — **النزيل يقدر يغيّر تاريخ الموبايل ويتلاعب**. لضمان عدم التلاعب: السيرفر يتحقق من **آخر تاريخ لفة** لهذا الرقم (من الشيت/DB) ويستخدم **وقت السيرفر**؛ لو مرّ أقل من 15 يوم يرجّع `allowed: false`.
- **مع Google Apps Script:** استخدم `google.script.run.withSuccessHandler`:
  - الصفحة تستدعي دالة في السكربت (مثلاً `checkCanSpin(phone)`).
  - السكربت يتحقق من الشيت/قاعدة البيانات (وقت السيرفر) ويرجع `true` أو `false`.
  - في `withSuccessHandler` فقط لو النتيجة `true` ننتقل لشاشة العجلة ونديرها. بهذا **العجلة لا تبدأ الدوران إلا بعد تأكيد السيرفر**.

---

## ٣.٢. Token Validation (تأمين الشيت)

- **لما الصفحة تفتح:** يُولَّد Token فريد (UUID) ويُخزَّن في **Session** (sessionStorage).
- **عند الإرسال:** كل طلب تصدير (عضو جديد أو طابور معلق) يضمّن **sessionToken** في الـ payload.
- **السيرفر (Google Script أو غيره):** يتأكد أن الـ Token صالح ولم يُستخدم من قبل (مثلاً تسجيله في شيت أو Redis)، ثم ي markه كمُستخدم.
- **النتيجة:** منع أي حد يستخدم Postman أو سكربت يغمر الشيت بداتا وهمية — كل طلب مرتبط بجلسة صفحة واحدة وToken يُقبل مرة واحدة.

---

## ٣.٣. الـ Vibe في حركة العجلة (Easing)

- استخدام **Cubic-Bezier(0.1, 0, 0, 1)** في حساب التقدم (مُطبَّق في RAF عبر `cubicBezierEaseOut`).
- نفس شعور **CSS transition: transform 17s cubic-bezier(0.1, 0, 0, 1)** — حركة "فخمة"، العجلة بتقاوم الجاذبية وبتهدي ببطء (احتكاك).

---

## ٣.٤. Auto-Complete / تقنيع البيانات للعائدين

- لو الضيف مسجّل قبل كده: عرض ترحيب مقنّع:
  - **الاسم:** أول حرف + `****` (مثلاً "أستاذ م****").
  - **الهوية:** "هل هذا هو رقم هويتك المنتهي بـ (***45)؟" إذا وُجدت آخر أرقام من التسجيل السابق.
- الهدف: سرعة دخول + إحساس بالأمان (بياناته مش مكشوفة لو حد واقف جنبه).

---

## ٤. Anti-Fraud Physics (Server-Side Probability)

### المشكلة
لو عندك جائزة غالية (إقامة مجانية مثلاً)، أي حد يفتح الـ Console ويغيّر النتيجة يقدر يتلاعب.

### الحل: النتيجة من السيرفر فقط
1. **لما الضيف يدوس "لف":** الموبايل يبعث طلب للسيرفر (مثلاً Google Apps Script) ويضمّن: رقم الجوال، معرف الجلسة، إلخ.
2. **السيرفر يحدد الزاوية (أو index الجائزة):** حسب الاحتمالات والـ quota، السيرفر يرجّع `{ winnerIndex }` أو `{ stopAngle }`.
3. **الموبايل يعرض الحركة فقط:** العجلة تدور وتوقف عند الزاوية المُرسلة من السيرفر. مفيش أي قرار في الفرونت.
4. **النتيجة:** مفيش حد يقدر يتلاعب بالنتيجة من المتصفح — السيرفر هو مصدر الحقيقة الوحيد.

### تطبيق لاحق (عند وجود Script)
- إضافة إعداد اختياري (مثلاً `spinResultWebhookUrl`): عند الضغط على "لف" يتم استدعاء الـ Webhook بـ `{ phone }` ويُتوقَّع الرد `{ winnerIndex: number }`.
- العجلة تستخدم `winnerIndex` بدل `Math.random()` وتلف لتوقف على الشريحة المحددة.

---

## ٥. أداء العجلة (Performance)

- **requestAnimationFrame:** دوران العجلة يعتمد على `requestAnimationFrame` وليس `setInterval`، مع **Cubic-Bezier(0.1, 0, 0, 1)** للتباطؤ، لتحقيق:
  - توقيت ناعم مع تحديث الشاشة (60fps عند الإمكان)
  - تقليل استهلاك البطارية على الموبايل
  - دوران سلس (Smooth) بدون تقطيع
