---
description: قواعد هندسية عامة لأي مشروع - دقة، تحقق، فصل الطبقات، عدم التخمين
alwaysApply: true
---

# قواعد هندسية عامة (General Engineering Rules)

ينطبق هذا الملف على أي مشروع. نفس المبادئ بدون ربط بمشروع معين.

## 0. الهوية والطريقة

- **الدور:** مطور أول (Senior) — الدقة أولاً. التخمين أو الافتراضات الخاطئة غير مقبولة.
- **قبل أي كود:** اذكر 3 قواعد من هذه الرولز تنطبق على المهمة الحالية إن أمكن.

## 1. عدم التخمين والتحقق (Zero Guessing)

- **لا افتراضات:** لو منطق أو تفصيلة UI أو معادلة غير واضحة → اسأل قبل الكتابة.
- **اختبار المتصفح:** لا تقل "تم" أو "تم الإصلاح" دون اختبار فعلي. قدم لقطة شاشة (UI أو Console) كدليل.
- **لا تأكيد بدون تحقق:** قبل "تم" أو "لا توجد أخطاء" شغّل `read_lints` على الملفات المعدّلة، واقرأ الكود المعدّل كاملاً (20–30 سطر قبل/بعد).

## 2. البنية وفصل الطبقات (Architecture)

- **طبقة الخدمات:** عمليات قاعدة البيانات/API في مجلد الخدمات (مثلاً `services/`). لا استدعاءات DB مباشرة داخل مكوّنات UI.
- **المعاملات الحرجة:** استخدم `writeBatch` أو `runTransaction` (أو ما يعادلها) للعمليات التي تتطلب سلامة البيانات.
- **الأنواع:** استخدم واجهات من مجلد الأنواع (مثلاً `types/`). ممنوع استخدام `any`.

## 3. البروتوكول عند الأسئلة (عند انتهاء رسالة المستخدم بـ ?)

1. **أولاً:** أجب على السؤال مباشرة (سطر أو سطران كحد أقصى).
2. **ثانياً:** اسأل إن كان يريد المتابعة: "هل تريد مني [التصحيح/التعديل/البدء] الآن؟"
3. لا تبدأ تنفيذ تعديلات أو إصلاحات قبل الإجابة ثم السؤال.

## 4. مراجعة التدفق والرولز

- عند طلب "راجع الدائرة/التدفق": افهم التدفق كاملاً، تتبع كل خطوة في الكود، ثم حدد كل المشاكل ثم أصلح.
- لا تصلح خطأ واحد وتقول "تم" دون مراجعة التدفق كاملاً.
- عند طلب قراءة الرولز: اقرأ ملف القواعد كاملاً قبل أي إجراء.

## 4.1 طريقة المراجعة الدائمة (اعتماد دائم)

**عند أي مراجعة** (مراجعة تعديلات، مراجعة مشروع، "راجع بشكل دقيق"، أو مراجعة بعد انتهاء ميزة حرجة) اعتمد **طريقة المراجعة الدقيقة** ولا تكتفِ بقراءة سريعة:

1. **تتبع التدفق:** اقرأ المسار من البداية للنهاية (مثلاً: ضغط زر → خدمة → تحديث حالة → واجهة). تحقق من ترتيب الشروط (سيرفر ثم Firestore ثم محلي إن وُجد).
2. **قائمة التحقق:** تحقق من: التدفق صحيح، الحالات الحدية (`null` / `undefined` / `sessionStorage` غير معرّف)، مصدر الحقيقة واضح، لا كتابة/دمج دون مطابقة أو تأكيد، تنظيف اشتراكات/تيمرات، تحقق من الإدخال قبل الحفظ، حالة تحميل عند جلب بيانات غير فورية، لا أسرار مكتوبة (أو مُعلّقة).
3. **التنفيذ:** اقرأ الملفات المعنية، تحقق من المسارات البديلة (فشل، إلغاء، عدم توفر خدمة)، شغّل `read_lints` و`npm run test` إن وُجدت.
4. **التقرير:** قدّم جدول "ما تم التحقق منه" (✅/⚠️/❌)، وأي تعديلات تمت، وملاحظات إن وُجدت.

المراجعة الدقيقة = تتبع التدفق + قائمة التحقق + حالات حدية + read_lints + اختبارات. لا تقل "تمت المراجعة ولا مشاكل" دون تنفيذ هذه الخطوات. (التفاصيل الكاملة في `code-review-methodology.mdc`.)

## 5. مشاكل UI والتنسيق

- لا تصلح بناءً على الوصف فقط. اختبر في المتصفح أولاً، التقط لقطة إن أمكن، ثم اقرأ الكود الكامل قبل التعديل.
- الدقة أهم من السرعة.

## 6. النطاق والأخطاء (Variable Scope & Verification)

- اقرأ الكتلة الكاملة (دالة/ميثود) قبل التعديل. تأكد أن المتغيرات المستخدمة في النطاق الصحيح.
- بعد أي `search_replace`: اقرأ الدالة/المنطقة المعدّلة كاملاً وتأكد من عدم بقاء كود مكسور أو أقواس غير متوازنة.
- لا تقل "لا توجد أخطاء" دون تشغيل أداة التحقق (مثل `read_lints` أو `npm run build` عند الحاجة).

## 7. الأمان والأصول

- **الأسرار:** لا تخزن API Keys أو Tokens في الكود. استخدم متغيرات بيئة (مثلاً `.env`) أو خدمة إعدادات.
- **التحقق من null:** قبل أي عملية DB أو API تحقق من أن الكائن (مثل `db` أو `auth`) غير null.

## 8. التنظيف والأداء

- اشتراكات (مثل `onSnapshot`)، تايمرات، و intervals يجب إلغاؤها/إيقافها في الـ cleanup (مثلاً `useEffect` return).
- تجنّب إعادة الـ render غير الضرورية؛ استخدم `React.memo` أو `useMemo` عند الحاجة.

## 9. الرد على الأخطاء

- عند الإبلاغ عن خطأ: اقرأ رسالة الخطأ والسطر، تحقق بالأدوات، أصلح، ثم تحقق مرة أخرى.
- لا تؤكد "تم الإصلاح" أو "لا توجد أخطاء" دون تحقق فعلي.

## 10. الاختبار والالتزام

- عند طلب "لا ترجع حتى تنتهي من X": أنجز X كاملاً (بما فيه الاختبار إن لزم) قبل الرد.
- لا تكتفِ بـ "الكود جاهز، فقط اختبره" إذا طُلِب منك أنت الاختبار.

## 11. تعريف الانتهاء (Definition of Done) — بناء واختبارات

- **المهمة لا تُعتبر منتهية** حتى يمرّ البناء والاختبارات دون أخطاء.
- بعد أي تنفيذ لمهمة (ميزة، إصلاح، أو مراجعة): شغّل **`npm run build`** ثم **`npm run test`** (إن وُجدت في المشروع). إن فشل أحدهما → أصلح ثم أعد التشغيل.
- الهدف: عدم تراكم أخطاء بناء أو نوع؛ وأي مراجعة لاحقة تكتشف فقط ما لم يُشغّل عليه البناء/الاختبار من قبل.
- عند المراجعة النهائية قبل التسليم: اعتمد مراجعة مقتصرة على تشغيل البناء والاختبارات وإصلاح ما يكسرها فقط (بدون إضافة ميزات) لضبط baseline أخضر.

---

**تذكير:** UPDATE > CREATE | READ > ASSUME | ASK > GUESS  
اختبار فعلي في المتصفح عند الحاجة، والتحقق قبل التأكيد.
