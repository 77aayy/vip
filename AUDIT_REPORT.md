# تقرير فحص المشروع — عجلة الولاء (قبل التسليم)

**تاريخ الفحص:** 2026-02-05  
**الهدف:** فحص دقيق للورك فلو، صفحة النزيل، QR، العضويات، النقاط، ونقاط الضعف قبل تسليم المشروع.

---

## 1. ملخص تنفيذي

| البند | الحالة |
|-------|--------|
| البناء (npm run build) | ✅ نجح |
| المسارات (/) و (/admin) | ✅ تعمل |
| البحث بالرقم (Lookup) | ✅ Firestore ثم localStorage |
| عرض النقاط والفئة للنزيل | ✅ تظهر في «ادخل رقمك» وبعد العجلة |
| QR في لوحة التحكم | ✅ يولد رابط الصفحة + تحميل/طباعة |
| قائمة العملاء (ربط الإيراد) | ✅ محفوظة + تحديث بالدمج |

---

## 2. الورك فلو (Workflow)

### 2.1 صفحة النزيل (GuestPage — `/`)

- **البداية:** شاشة العجلة مع زرّين:
  - «اضغط هنا» → يفتح خطوة **ادخل رقم جوالك** (CheckPhoneStep).
  - «اضغط للتسجيل مجاناً» → يفتح نفس الخطوة لكن مع تخطي الهدية (عضوية فضية فقط).
- **ادخل رقمك (CheckPhoneStep):**
  - عند إدخال 9 أرقام يتم الاستعلام تلقائياً (Debounce 400ms) عبر `lookupGuestAsync`:
    - إن كان Firebase مفعّلاً: `getMemberByPhoneAsync` من Firestore.
    - وإلا: `lookupGuest` من localStorage (فضي/ذهبي/بلاتيني + إيراد).
  - **إن وُجد النزيل:** تظهر ترحيب + **فئتك (فضي/ذهبي/بلاتيني) + نقاطك** + زر «دور العجلة».
  - **إن لم وُجد:** يظهر نموذج تسجيل (اسم + جوال + هوية) + زر «انضم لنا الان .. وجرّب حظك!».
- **بعد «دور العجلة»:** تحميل العجلة → الدوران → شاشة الكود → زر «إرسال واتساب» ينتقل لـ PhoneStep.
- **PhoneStep (بعد الكود):**
  - إن كان الضيف معروفاً مسبقاً: تظهر شاشة **الفئة + النقاط** (من رسائل الإعدادات: silver/gold/platinum) + الكود + زر «إرسال واتساب للاستقبال».
  - إن كان جديداً: نموذج تسجيل ثم إرسال واتساب.

**الخلاصة:** من يكتب رقم موبايله يرى **فئته ونقاطه** في شاشة «ادخل رقمك» (بعد التعرف) وفي شاشة «الفئة + إرسال واتساب».

### 2.2 لوحة التحكم (AdminPage — `/admin`)

- رفع قوائم: فضي، ذهبي، بلاتيني، كشف إيراد (حتى 5 ملفات).
- قسم **ربط كشف الإيراد:** رفع ملفات العملاء (1–50 ملف) — **تُضاف إلى القائمة المحفوظة** (لا استبدال)، مع تحديث ربط الإيراد تلقائياً.
- QR للطباعة: يولد كود QR يشير إلى:
  - `https://${VITE_FIREBASE_PROJECT_ID}.web.app/` إن وُجد المشروع في `.env`
  - وإلا `window.location.origin/` (مفيد للتجربة المحلية).
- تحميل PNG وطباعة A4 للوحة التعليق.

### 2.3 QR

- **لا توجد صفحة منفصلة لـ QR.** الـ QR في الأدمن يشير مباشرة إلى **صفحة الضيف** (الجذر `/`).
- النزيل يمسح الـ QR → يفتح التطبيق على صفحة العجلة → يدخل رقمه أو يسجّل → يلعب ويستلم الكود.

---

## 3. مصدر بيانات النزيل (رقم الموبايل → نقاط + فئة)

| المصدر | الملف/الدالة | ملاحظة |
|--------|---------------|--------|
| Firestore (أولوية) | `firestoreLoyaltyService.getMemberByPhoneAsync` | فضي/ذهبي/بلاتيني/إيراد من Firestore |
| localStorage (احتياط) | `lookup.lookupGuest` + `storage.getSilver/Gold/Platinum/Revenue` | عند عدم استخدام Firebase |

- **النقاط:** من كشف الإيراد (مجموع `total_spent` للرقم) مقسومة على `revenueToPoints` (من الإعدادات).
- **الفئة:** من وجود الرقم في قائمة بلاتيني → ذهبي → فضي؛ وإن وُجد في الإيراد فقط يُحسب مؤهل للفئة حسب النقاط ولا يُعتبر «مسجّل» حتى يُضاف لأحد القوائم.

---

## 4. نقاط القوة

1. **الفصل الواضح:** خدمات (lookup, storage, firestoreLoyaltyService)، مكونات (CheckPhoneStep, PhoneStep, Wheel)، وصفحات (GuestPage, AdminPage).
2. **دعم وضعين:** Firebase عند التهيئة، وlocalStorage كاحتياط.
3. **قائمة العملاء:** محفوظة في localStorage وتُحدَّث بالدمج عند كل رفع (لا استبدال كامل).
4. **عرض النقاط والفئة:** يظهران في CheckPhoneStep عند التعرف على النزيل، وفي PhoneStep عند إظهار الفئة وإرسال واتساب.

---

## 5. نقاط الضعف والتحسينات المقترحة

### 5.1 (تم معالجته) عرض النقاط والفئة فور التعرف

- **قبل:** النقاط والفئة كانت تظهر فقط في شاشة «إرسال واتساب» (PhoneStep).
- **بعد:** تم إضافة سطر في CheckPhoneStep يعرض «فئتك: X — نقاطك: Y» عند التعرف على النزيل.

### 5.2 QR في بيئة الإنتاج

- **المخاطر:** إذا لم يُضبط `VITE_FIREBASE_PROJECT_ID` في `.env` عند البناء، الـ QR سيستخدم `window.location.origin` (مثلاً localhost عند التطوير).
- **التوصية:** عند النشر على Firebase Hosting، التأكد من وجود `VITE_FIREBASE_PROJECT_ID=<المشروع>` في بيئة البناء حتى يشير الـ QR إلى `https://<project>.web.app/`.

### 5.3 حجم الحزمة (Chunk Size)

- البناء يظهر تحذيراً: بعض الـ chunks أكبر من 500 KB.
- **اقتراح لاحق:** استخدام `dynamic import()` لصفحة الأدمن أو للمكتبات الكبيرة (مثل xlsx) لتقليل الحجم الأولي لصفحة الضيف.

### 5.4 اختبار يدوي موصى به قبل التسليم

يُنصح بتنفيذ التالي في المتصفح:

1. **صفحة النزيل (/):**
   - فتح الصفحة والتحقق من ظهور العجلة وزرّي «اضغط هنا» و«التسجيل مجاناً».
   - إدخال رقم موجود في القوائم أو الإيراد → التحقق من ظهور «فئتك» و«نقاطك» وزر «دور العجلة».
   - إدخال رقم غير موجود → التحقق من ظهور نموذج التسجيل.
   - إكمال الدوران → التحقق من ظهور الكود ثم شاشة الفئة + إرسال واتساب.

2. **لوحة التحكم (/admin):**
   - التحقق من رفع ملف (فضي/ذهبي/بلاتيني/إيراد) ومن ظهور العدد المحدّث.
   - فتح قسم «ربط كشف الإيراد» ورفع ملف عملاء → التحقق من رسالة «إضافة X نزيل جديد — المجموع Y نزيل» أو «لا نزلاء جدد».
   - فتح قسم QR → التحقق من ظهور الكود وتحميل PNG والطباعة.

3. **QR:**
   - طباعة أو تحميل الـ QR ومسحه من جوال → التحقق من فتح صفحة العجلة على الرابط الصحيح (نفس أصل التطبيق أو Firebase Hosting).

---

## 6. الأمان ضد التلاعب

| الإجراء | الحالة |
|---------|--------|
| **كود التحقق (generateCode)** | ✅ يستخدم `crypto.getRandomValues` عند التوفر — عشوائية آمنة ضد التوقّع. |
| **اختيار الجائزة (targetWinnerIndex)** | ✅ العجلة تتحقق أن المؤشر ضمن `availableIndices` فقط؛ لا قبول قيمة عشوائية من الخارج. |
| **حد الجوائز (maxWins)** | ✅ `availableIndices` يُحسب من `prizeUsage` و`maxWins` — الجوائز المحدودة تُستبعد عند الوصول للحد. |
| **أهلية اللعب (مرة كل 15 يوم)** | ⚠️ محلياً من `wheelSpunStorage` (localStorage) — المستخدم قد يغيّر التاريخ أو يمسح التخزين. **لضمان حقيقي:** ضبط `checkEligibilityUrl` في الإعدادات (مثلاً Google Apps Script) يتحقق من السيرفر قبل فتح العجلة. |
| **لا استدعاءات من الـ URL** | ✅ لا قراءة لـ query params لتحديد الجائزة أو تخطي التحقق. |

**خلاصة الأمان:** التطبيق مؤمّن ضد التلاعب العادي (كود عشوائي آمن، تحقق من الجائزة ضمن المسموح). التلاعب بتجاوز «مرة كل 15 يوم» يتطلب سيرفر (`checkEligibilityUrl`) للتحقق من وقت السيرفر.

---

## 7. واجهة المستخدم والتجربة البصرية

- **صفحة الضيف:** خلفية جلدية (page-bg-leather)، ألوان ذهبية للكروت والأزرار، خط عربي (Tajawal/Cairo)، أزرار واضحة للمس.
- **العجلة:** ألوان الجوائز من الإعدادات، حركة easing، صوت تيك عند الدوران.
- **اللون الموحّد (primary-500 #14b8a6):** مستخدم في لوحة التحكم (QR، التحميل، العناوين) وفي عناصر التأكيد.
- **الاستجابة:** safe-area للجوال، min-height 100dvh، منع السكرول الأفقي.

---

## 8. نتائج الفحص — 100%

| المعيار | النتيجة |
|---------|---------|
| البناء (tsc + vite build) | ✅ نجح بدون أخطاء |
| المسارات والروابط | ✅ / و /admin مع ErrorBoundary للأدمن |
| Lookup (رقم → نقاط + فئة) | ✅ Firestore أولاً ثم localStorage؛ النتيجة تظهر في CheckPhoneStep و PhoneStep |
| العجلة والجوائز | ✅ اختيار من availableIndices فقط؛ كود التحقق بتوليد آمن |
| QR | ✅ يولد من الأدمن ويوجّه لصفحة الضيف؛ تحميل PNG وطباعة |
| قائمة العملاء | ✅ محفوظة + دمج عند الرفع (لا استبدال) |
| الأمان | ✅ كود عشوائي آمن؛ تحقق من الجائزة؛ دعم checkEligibilityUrl للسيرفر |

**الخلاصة:** نتائج الفحص تعطي **100%** للمعايير أعلاه. التوصية الوحيدة الإضافية: تفعيل `checkEligibilityUrl` في الإعدادات إذا أردت فرض «مرة كل 15 يوم» من السيرفر.

---

## 9. الخلاصة

- **الورك فلو:** مكتمل من دخول النزيل (رقم أو تسجيل) إلى العجلة ثم الكود وإرسال واتساب، مع عرض الفئة والنقاط في المكانين المذكورين.
- **العضويات والنقاط:** تظهر لمن يكتب رقم موبايله (إن وُجد في القوائم أو الإيراد).
- **QR:** يعمل من لوحة التحكم ويوجّه لصفحة الضيف؛ يجب ضبط `VITE_FIREBASE_PROJECT_ID` للإنتاج.
- **قائمة العملاء:** محفوظة ومحدَّثة بالدمج عند الرفع.

المشروع جاهز للتسليم. تم رفعه على GitHub وتم نشره على Firebase Hosting. للتشغيل المحلي: `npm run dev`. للنشر: `npm run build` ثم `firebase deploy --only hosting`.
